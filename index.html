<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Copilot SSO Chat (MSAL 1.x)</title>
  <script src="https://alcdn.msauth.net/browser/1.4.4/js/msal.min.js"></script>
  <script src="https://cdn.botframework.com/botframework-webchat/latest/webchat.js"></script>
  <style>
    html, body { height: 100%; margin: 0; font-family: sans-serif; }
    #webchat { height: 100%; width: 100%; }
  </style>
  <script>
    var clientApplication;
    (function () {
      var msalConfig = {
        auth: {
          clientId: "e628e78d-0e45-4be2-ac61-7c7facc5b141",
          authority: "https://login.microsoftonline.com/959d9200-12be-4937-9ff4-a42df3cd2427"
        },
        cache: {
          cacheLocation: "localStorage",
          storeAuthStateInCookie: false
        }
      };
      clientApplication = new Msal.UserAgentApplication(msalConfig);
    })();
  </script>
</head>
<body>
  <div id="webchat"></div>

  <script>
    function getOAuthCardResourceUri(activity) {
      if (
        activity?.attachments?.[0]?.contentType === 'application/vnd.microsoft.card.oauth' &&
        activity.attachments[0].content.tokenExchangeResource
      ) {
        return activity.attachments[0].content.tokenExchangeResource.uri;
      }
    }

    function exchangeTokenAsync(resourceUri) {
      const user = clientApplication.getAccount();
      if (user) {
        const requestObj = {
          scopes: [resourceUri]
        };
        return clientApplication.acquireTokenSilent(requestObj)
          .then(response => response.accessToken)
          .catch(error => {
            console.error("Error intercambiando token:", error);
            return null;
          });
      }
      return Promise.resolve(null);
    }

    async function fetchJSON(url) {
      const res = await fetch(url);
      if (!res.ok) throw new Error(`Error al obtener ${url}: ${res.status}`);
      return res.json();
    }

    (async function main() {
      const BOT_ID = "crcf9_asistenteHavas";
      const directLineTokenUrl = `https://powerva.microsoft.com/api/botmanagement/v1/directline/directlinetoken?botId=${BOT_ID}`;
      const regionalChannelSettingsURL = `https://powerva.microsoft.com/api/botmanagement/v1/channelsettings`;

      // Obtener el token
      const { token } = await fetchJSON(directLineTokenUrl);

      // Obtener la URL regional correcta
      const regionalSettings = await fetchJSON(regionalChannelSettingsURL);
      const directLineDomain = regionalSettings.channelUrlsById.directline;

      const directLine = window.WebChat.createDirectLine({
        domain: `${directLineDomain}v3/directline`,
        token
      });

      const userID = clientApplication.account?.accountIdentifier
        ? ("usr-" + clientApplication.account.accountIdentifier).substr(0, 64)
        : (Math.random().toString(36) + Date.now()).substr(0, 64);

      const store = WebChat.createStore({}, ({ dispatch }) => next => action => {
        if (action.type === 'DIRECT_LINE/CONNECT_FULFILLED') {
          dispatch({
            type: 'WEB_CHAT/SEND_EVENT',
            payload: {
              name: 'startConversation',
              type: 'event',
              value: { text: "hello" }
            }
          });
        }

        if (action.type === 'DIRECT_LINE/INCOMING_ACTIVITY') {
          const activity = action.payload.activity;
          const resourceUri = getOAuthCardResourceUri(activity);
          if (activity.from?.role === 'bot' && resourceUri) {
            exchangeTokenAsync(resourceUri).then(token => {
              if (token) {
                directLine.postActivity({
                  type: 'invoke',
                  name: 'signin/tokenExchange',
                  value: {
                    id: activity.attachments[0].content.tokenExchangeResource.id,
                    connectionName: activity.attachments[0].content.connectionName,
                    token
                  },
                  from: {
                    id: userID,
                    name: clientApplication.account?.name || "Usuario",
                    role: "user"
                  }
                }).subscribe();
              }
            });
          }
        }

        return next(action);
      });

      const styleOptions = {
        botAvatarInitials: "Bot",
        userAvatarInitials: "TÃº",
        hideUploadButton: true
      };

      window.WebChat.renderWebChat({
        directLine,
        store,
        userID,
        styleOptions
      }, document.getElementById('webchat'));
    })().catch(err => console.error("Error en main:", err));
  </script>
</body>
</html>
