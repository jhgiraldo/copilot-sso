<!DOCTYPE html>
<html lang="en">

<head>
    <title>Contoso Sample Web Chat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <script src="https://cdn.botframework.com/botframework-webchat/latest/webchat.js"></script>
    <script type="text/javascript" src="https://alcdn.msauth.net/browser/2.32.0/js/msal-browser.min.js"></script>
    <script type="text/javascript">
        if (typeof msal === 'undefined') document.write(unescape("%3Cscript src='https://alcdn.msftauth.net/browser/2.32.0/js/msal-browser.min.js' type='text/javascript' %3E%3C/script%3E"));
    </script>
    <style>
        html, body { height: 100%; margin: 0; font-family: "Segoe UI", sans-serif; }
        #header { background-color: rgb(11, 85, 106); color: white; font-weight: 600; height: 48px; padding: 0 13px; display: flex; justify-content: space-between; align-items: center; }
        #subheader { background-color: rgb(243, 242, 241); padding: 7px 13px; font-size: 12px; font-weight: 400; }
        a { color: rgb(0, 90, 158); }
        a:hover { color: rgb(0, 69, 120); }
        #webchat { position: fixed; height: calc(100% - 125px); width: 100%; top: 125px; overflow: hidden; }
        #logout { display: none; }
    </style>
</head>

<body>
    <h1 style="text-align:center; color:#0a6fb7; font-family:Segoe UI">ðŸš€ Â¡Mi pÃ¡gina Copilot con SSO estÃ¡ cargando bien!</h1>

    <div id="chatwindow">
        <div id="header">SSO Test Bot</div>
        <div id="subheader">
            <span id="loginStatus">You are not logged in on the website.</span>
            <a id="login" href="#" onclick="onSignInClick()">Log in</a>
            <a id="logout" href="#" onclick="onSignOutClick()">Log out</a>
        </div>
        <div id="webchat"></div>
    </div>

    <script>
        const clientId = "YOUR_CLIENT_ID";
        const tenantId = "YOUR_TENANT_ID";
        const tokenEndpoint = "YOUR_TOKEN_ENDPOINT";

        const msalConfig = {
            auth: {
                clientId: clientId,
                authority: "https://login.microsoftonline.com/" + tenantId
            },
            cache: {
                cacheLocation: "sessionStorage",
                storeAuthStateInCookie: false
            }
        };

        const loginRequest = { scopes: ["User.Read", "openid", "profile"] };
        const msalInstance = new msal.PublicClientApplication(msalConfig);

        async function onSignInClick() {
            try {
                const loginResponse = await msalInstance.loginPopup(loginRequest);
            } catch (err) { console.log(err); }

            const accounts = msalInstance.getAllAccounts();
            if (accounts.length > 0) {
                msalInstance.setActiveAccount(accounts[0]);
                user = accounts[0];
                document.getElementById("loginStatus").innerHTML = "Currently logged in as " + user.name + " on the website.";
                document.getElementById("login").style.display = "none";
                document.getElementById("logout").style.display = "inline";
                await renderChatWidget();
            }
        }

        let user = null;
        const accounts = msalInstance.getAllAccounts();
        if (accounts.length > 0) {
            user = accounts[0];
            msalInstance.setActiveAccount(user);
            document.getElementById("loginStatus").innerHTML = "Currently logged in as " + user.name + " on the website.";
            document.getElementById("login").style.display = "none";
            document.getElementById("logout").style.display = "inline";
        }

        async function onSignOutClick() {
            await msalInstance.logoutPopup({ account: user });
            location.reload();
        }
    </script>

    <script>
        function getOAuthCardResourceUri(activity) {
            if (activity && activity.attachments && activity.attachments[0]?.contentType === 'application/vnd.microsoft.card.oauth' && activity.attachments[0].content.tokenExchangeResource) {
                return activity.attachments[0].content.tokenExchangeResource.uri;
            }
        }

        async function exchangeTokenAsync(resourceUri) {
            let user = msalInstance.getAllAccounts();
            if (user.length <= 0) return null;

            const tokenRequest = { scopes: [resourceUri] };
            try {
                const tokenResponse = await msalInstance.acquireTokenSilent(tokenRequest);
                return tokenResponse.accessToken;
            } catch (err) {
                console.log(err);
                return null;
            }
        }

        async function fetchJSON(url, options = {}) {
            const res = await fetch(url, {
                ...options,
                headers: { ...options.headers, accept: 'application/json' }
            });
            if (!res.ok) throw new Error(`Failed to fetch JSON due to ${res.status}`);
            return await res.json();
        }
    </script>

    <script>
        async function renderChatWidget() {
            var userID = user?.localAccountId ? user.localAccountId.substr(0, 36) : (Math.random().toString() + Date.now().toString()).substr(0, 64);
            const { token } = await fetchJSON(tokenEndpoint);
            const directLine = window.WebChat.createDirectLine({ token });

            const store = WebChat.createStore({}, ({ dispatch }) => next => action => {
                const { type } = action;

                if (action.type === "DIRECT_LINE/CONNECT_FULFILLED") {
                    dispatch({
                        meta: { method: "keyboard" },
                        payload: {
                            activity: {
                                channelData: { postBack: true },
                                name: 'startConversation',
                                type: "event"
                            }
                        },
                        type: "DIRECT_LINE/POST_ACTIVITY"
                    });
                }

                if (type === 'DIRECT_LINE/INCOMING_ACTIVITY') {
                    const activity = action.payload.activity;
                    let resourceUri;
                    if (activity.from?.role === 'bot' && (resourceUri = getOAuthCardResourceUri(activity))) {
                        exchangeTokenAsync(resourceUri).then(token => {
                            if (token) {
                                directLine.postActivity({
                                    type: 'invoke',
                                    name: 'signin/tokenExchange',
                                    value: {
                                        id: activity.attachments[0].content.tokenExchangeResource.id,
                                        connectionName: activity.attachments[0].content.connectionName,
                                        token
                                    },
                                    from: { id: userID, name: user.name, role: "user" }
                                }).subscribe(
                                    id => { if (id === 'retry') return next(action); },
                                    error => next(action)
                                );
                                return;
                            } else return next(action);
                        });
                    } else return next(action);
                } else return next(action);
            });

            const styleOptions = {
                hideUploadButton: true,
                botAvatarImage: 'https://bot-framework.azureedge.net/bot-icons-v1/6ab9b101-b65c-4357-9e9f-915cbf313a14_2K5Bt02aW8egEb97fxAgh7vqChK4UV3Nh3Lw3YYArhEKR8mB.png',
                botAvatarInitials: 'Bot',
                userAvatarImage: 'https://content.powerapps.com/resource/makerx/static/media/user.0d06c38a.svg',
                userAvatarInitials: 'User'
            };

            window.WebChat.renderWebChat({ directLine, store, userID, styleOptions }, document.getElementById('webchat'));
        }

        (async () => {
            await renderChatWidget();
        })();
    </script>
</body>

</html>
