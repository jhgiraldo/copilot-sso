<!DOCTYPE html>
<html lang="en">
<head>
  <title>Copilot SSO Test</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.botframework.com/botframework-webchat/latest/webchat.js"></script>
  <script src="https://alcdn.msauth.net/browser/2.32.0/js/msal-browser.min.js"></script>
  <style>
    html, body { height: 100%; margin: 0; font-family: "Segoe UI", sans-serif; }
    #header { background-color: #0b556a; color: white; padding: 10px; font-weight: bold; }
    #subheader { background-color: #f3f2f1; padding: 10px; font-size: 14px; }
    #webchat { height: calc(100% - 100px); }
    #logout { display: none; }
  </style>
</head>
<body>
  <div id="header">Copilot SSO Web Chat</div>
  <div id="subheader">
    <span id="loginStatus">No has iniciado sesión.</span>
    <a id="login" href="#" onclick="onSignInClick()">Iniciar sesión</a>
    <a id="logout" href="#" onclick="onSignOutClick()">Cerrar sesión</a>
  </div>
  <div id="webchat"></div>

  <script>
    const clientId = "95f8f362-b44c-4b6d-84aa-ce37fd251c04";
    const tenantId = "c7ed5557-a5c8-4435-9fab-ada7abcdc01b";
    const tokenEndpoint = "https://1e256ba4f2f8ec3ca82251b8b111f2.4a.environment.api.powerplatform.com/powervirtualagents/botsbyschema/cr5e6_agente/directline/token?api-version=2022-03-01-preview";

    const msalInstance = new msal.PublicClientApplication({
      auth: {
        clientId,
        authority: "https://login.microsoftonline.com/" + tenantId
      },
      cache: {
        cacheLocation: "sessionStorage",
        storeAuthStateInCookie: false
      }
    });

    const loginRequest = {
      scopes: ["User.Read", "openid", "profile"]
    };

    async function onSignInClick() {
      try {
        await msalInstance.loginPopup(loginRequest);
      } catch (err) {
        console.error(err);
      }

      const accounts = msalInstance.getAllAccounts();
      if (accounts.length > 0) {
        msalInstance.setActiveAccount(accounts[0]);
        user = accounts[0];
        document.getElementById("loginStatus").innerText = `Conectado como ${user.name}`;
        document.getElementById("login").style.display = "none";
        document.getElementById("logout").style.display = "inline";
        await renderChatWidget();
      }
    }

    async function onSignOutClick() {
      await msalInstance.logoutPopup({ account: user });
      location.reload();
    }

    let user = null;
    const accounts = msalInstance.getAllAccounts();
    if (accounts.length > 0) {
      user = accounts[0];
      msalInstance.setActiveAccount(user);
      document.getElementById("loginStatus").innerText = `Conectado como ${user.name}`;
      document.getElementById("login").style.display = "none";
      document.getElementById("logout").style.display = "inline";
    }

    async function fetchJSON(url, options = {}) {
      const res = await fetch(url, {
        ...options,
        headers: { ...options.headers, accept: 'application/json' }
      });
      if (!res.ok) throw new Error(`Error al obtener JSON: ${res.status}`);
      return res.json();
    }

    function getOAuthCardResourceUri(activity) {
      return activity?.attachments?.[0]?.content?.tokenExchangeResource?.uri;
    }

    async function exchangeTokenAsync(resourceUri) {
      if (!user) return null;
      try {
        const tokenResponse = await msalInstance.acquireTokenSilent({ scopes: [resourceUri] });
        return tokenResponse.accessToken;
      } catch (err) {
        console.error(err);
        return null;
      }
    }

    async function renderChatWidget() {
      const userID = user?.localAccountId?.substring(0, 36) || Math.random().toString(36).substring(2);
      const { token } = await fetchJSON(tokenEndpoint);
      const directLine = window.WebChat.createDirectLine({ token });

      const store = WebChat.createStore({}, ({ dispatch }) => next => action => {
        if (action.type === "DIRECT_LINE/CONNECT_FULFILLED") {
          dispatch({
            type: "DIRECT_LINE/POST_ACTIVITY",
            payload: {
              activity: {
                type: "event",
                name: "startConversation",
                channelData: { postBack: true }
              }
            },
            meta: { method: "keyboard" }
          });
        }

        if (action.type === "DIRECT_LINE/INCOMING_ACTIVITY") {
          const activity = action.payload.activity;
          const resourceUri = getOAuthCardResourceUri(activity);
          if (resourceUri) {
            exchangeTokenAsync(resourceUri).then(token => {
              if (token) {
                directLine.postActivity({
                  type: "invoke",
                  name: "signin/tokenExchange",
                  value: {
                    id: activity.attachments[0].content.tokenExchangeResource.id,
                    connectionName: activity.attachments[0].content.connectionName,
                    token
                  },
                  from: {
                    id: userID,
                    name: user.name,
                    role: "user"
                  }
                }).subscribe();
              }
            });
          }
        }
        return next(action);
      });

      WebChat.renderWebChat({
        directLine,
        store,
        userID,
        styleOptions: {
          botAvatarInitials: "Bot",
          userAvatarInitials: "Yo"
        }
      }, document.getElementById("webchat"));
    }
  </script>
</body>
</html>
